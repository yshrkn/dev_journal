---
import { getCollection } from 'astro:content'
import TableOfContents from './TableOfContents.astro'

const allPosts = await getCollection('blog')

// 目次を表示するかどうか（記事ページかどうかを判定）
const showToc = Astro.props.showToc ?? false

// タグを収集して記事数と一緒に管理
const tagCounts = new Map<string, number>()

allPosts.forEach((post) => {
  const tags = post.data.tags ?? []
  tags.forEach((tag) => {
    tagCounts.set(tag, (tagCounts.get(tag) ?? 0) + 1)
  })
})

// タグを記事数の多い順でソート（同数の場合は名前順）
const sortedTags = Array.from(tagCounts.entries()).sort(([a, countA], [b, countB]) => {
  if (countA !== countB) {
    return countB - countA // 記事数の降順
  }
  return a.localeCompare(b) // 名前の昇順
})

// 表示するタグ数を制限
const displayTags = sortedTags.slice(0, 10)
---

<div class="sidebar-container">
  {showToc && (
    <aside class="sidebar-box toc-box">
      <TableOfContents />
    </aside>
  )}
  
  <aside class="sidebar-box tags-box">
    <div class="sidebar-section">
      <h3>人気のタグ</h3>
      {displayTags.length === 0 ? (
        <p class="no-tags">タグはまだありません</p>
      ) : (
        <ul class="tag-list">
          {displayTags.map(([tag, count]) => (
            <li>
              <a href={`${import.meta.env.BASE_URL}/tags/${encodeURIComponent(tag)}`} class="tag-link">
                <span class="tag-name">#{tag}</span>
                <span class="tag-count">({count})</span>
              </a>
            </li>
          ))}
        </ul>
      )}
      {sortedTags.length > 10 && (
        <a href={`${import.meta.env.BASE_URL}/tags/`} class="view-all-tags">
          全てのタグを見る →
        </a>
      )}
    </div>
  </aside>
</div>

<style>
  .sidebar-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  
  @media (min-width: 1025px) {
    .sidebar-container {
      position: -webkit-sticky;
      position: sticky;
      top: calc(var(--header-height) + 2rem);
      align-self: start;
      max-height: calc(100vh - var(--header-height) - 4rem);
      overflow-y: auto;
      z-index: 10;
    }
  }
  
  .sidebar-box {
    background: rgb(var(--surface));
    border: 1px solid rgb(var(--border));
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    box-shadow: var(--box-shadow);
  }
  
  .toc-box {
    order: 1;
  }
  
  .tags-box {
    order: 2;
  }
  
  .sidebar-section h3 {
    margin: 0 0 1rem 0;
    color: var(--accent);
    font-size: 1.2rem;
    border-bottom: 2px solid var(--accent);
    padding-bottom: 0.5rem;
  }
  
  .tag-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .tag-list li {
    margin-bottom: 0.5rem;
  }
  
  .tag-link {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    text-decoration: none;
    color: rgb(var(--black));
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }
  
  .tag-link:hover {
    background: rgba(var(--accent), 0.1);
  }
  
  .tag-name {
    color: rgb(var(--accent));
    font-weight: 500;
  }
  
  .tag-count {
    color: rgb(var(--gray));
    font-size: 0.9rem;
  }
  
  .view-all-tags {
    display: inline-block;
    margin-top: 1rem;
    color: rgb(var(--accent));
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
  }
  
  .view-all-tags:hover {
    text-decoration: underline;
  }
  
  .no-tags {
    color: rgb(var(--gray));
    font-style: italic;
    margin: 0;
  }
  
  @media (max-width: 768px) {
    .sidebar-container {
      position: static;
      max-height: none;
      gap: 1.5rem;
    }
    
    .sidebar-box {
      padding: 1.25rem;
    }
  }
</style>